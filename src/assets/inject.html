<style>
  .add-border {
    border: 4px solid red !important;
  }
</style>

<script>
  function getElementByXpath(path) {
    return document.evaluate(
      path,
      document,
      null,
      XPathResult.FIRST_ORDERED_NODE_TYPE,
      null
    ).singleNodeValue;
  }

  const addBorder = (e) => {
    e.target.classList.add("add-border");
    // e.stopPropagation();
  };

  const removeBorder = (e) => {
    e.target.classList.remove("add-border");
  };

  function getPathTo(element) {
    if (element.id !== "") return 'id("' + element.id + '")';
    if (element === document.body) return element.tagName;

    var ix = 0;
    var siblings = element.parentNode.childNodes;
    for (var i = 0; i < siblings.length; i++) {
      var sibling = siblings[i];
      if (sibling === element)
        return (
          getPathTo(element.parentNode) +
          "/" +
          element.tagName +
          "[" +
          (ix + 1) +
          "]"
        );
      if (sibling.nodeType === 1 && sibling.tagName === element.tagName) ix++;
    }
  }

  function clickHandler(e) {
    e.preventDefault();
    const xPath = getPathTo(e.target);
    console.log(xPath);
    window.top.postMessage(xPath, "*");
  }

  function addClickHandler() {
    document.addEventListener("mouseover", addBorder);
    document.addEventListener("mouseout", removeBorder);
    document.addEventListener("click", clickHandler);
  }

  function removeClickHandler() {
    document.removeEventListener("mouseover", addBorder);
    document.removeEventListener("mouseout", removeBorder);
    document.removeEventListener("click", clickHandler);
  }

  addClickHandler();

  window.addEventListener("message", (ev) => {
    window.top.window.console.log(ev.action, ev.xPath, ev.execute);

    if (ev.data.action == "addClickHandler") {
      removeClickHandler();
      addClickHandler();
    }

    if (ev.data.action == "removeClickHandler") {
      removeClickHandler();
    }

    if (ev.data.action == "fetchElementHTMLByXpath") {
      let str = getElementByXpath(ev.data.xPath).outerHTML;
      window.top.window.console.log(str);
      window.top.postMessage(str, "*");
    }

    if (ev.data.action == "runAction") {
      window.top.window.console.log(ev.data.execute);
      eval(ev.data.execute);
    }
  });
</script>
